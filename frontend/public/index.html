<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas de Trámites y Usuarios</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="container mt-5">

    <h1>Estadísticas de Trámites y Usuarios</h1>
    
    <!-- Step 1: Seleccionar Fecha -->
    <div id="step1" class="step-container step-active">
        <div class="date-section">
            <h2>Seleccionar Rango de Fechas</h2>
            <div class="form-row">
                <div class="col">
                    <label>Fecha Desde:</label>
                    <input type="date" id="fechaDesde" class="form-control">
                </div>
                <div class="col">
                    <label>Fecha Hasta:</label>
                    <input type="date" id="fechaHasta" class="form-control">
                </div>
            </div>
            <button onclick="loadRoles()" class="btn btn-primary mt-3">Cargar Roles/Usuarios</button>
        </div>
        <p>Formato: DD-MM-YYYY. Se usará el último mes si no se selecciona.</p>
    </div>
    
    <!-- Step 2: Roles y Estadisticas de Usuarios -->
    <div id="step2" class="step-container">
        <h2>Roles y Estadísticas de Usuarios</h2>
        <button onclick="backToStep1()" class="btn btn-secondary">← Volver a Fechas</button>
        <div id="rolesTable">
            <div class="loading">Cargando roles...</div>
        </div>
    </div>
    
    <!-- Step 3: Detalles de Usuarios -->
    <div id="step3" class="step-container">
        <h2>Detalles de Usuarios por Rol: <span id="currentRol"></span></h2>
        <button onclick="backToStep2()" class="btn btn-secondary">← Volver a Roles</button>
        <button class="graficar-tramites btn btn-primary" data-bs-toggle="modal" data-bs-target="#tramitesModal" onclick="showChart('tramites')">Trámites</button>
        <button class="graficar-eficacia btn btn-primary" data-bs-toggle="modal" data-bs-target="#eficaciaModal" onclick="showChart('eficacia')">Eficacia</button>
        <div id="usersTable" class="table-responsive">
            <div class="loading">Cargando usuarios...</div>
        </div>
    </div> <!-- CIERRE CORRECTO DEL STEP 3 -->

    <!-- Modal para Gráfica de Trámites -->
    <div class="modal fade" id="tramitesModal" tabindex="-1" role="dialog" aria-labelledby="tramitesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-md-down modal-xl" role="document">
            <div class="modal-content" style="min-height: 80vh;">
                <div class="modal-header">
                    <h5 class="modal-title" id="tramitesModalLabel">ESTADISTICA DE TRAMITES POR USUARIO</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex align-items-center justify-content-center p-4">
                    <div class="chart-container" style="position: relative; height: 65vh; width: 100%;">        
                        <canvas id="tramitesChart"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Gráfica de Eficacia -->
    <div class="modal fade" id="eficaciaModal" tabindex="-1" role="dialog" aria-labelledby="eficaciaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-md-down modal-xl" role="document">
            <div class="modal-content" style="min-height: 80vh;">
                <div class="modal-header">
                    <h5 class="modal-title" id="eficaciaModalLabel">ESTADISTICAS DE EFICACIA POR USUARIO</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex align-items-center justify-content-center p-4">
                    <div class="chart-container" style="position: relative; height: 65vh; width: 100%;">
                        <canvas id="eficaciaChart"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4: Tramites de Usuarios -->
    <div id="step4" class="step-container">
        <h2>Trámites del Usuario: <span id="currentUsuario"></span></h2>
        <button onclick="backToStep3()" class="btn btn-secondary">← Volver a Usuarios</button>

        <div class="input-group mb-3" style="max-width: 300px; margin-top: 5px;">
            <input type="text" id="tramiteFilter" class="form-control" placeholder="Numero de Tramite" aria-label="Buscar trámite">
            <button class="btn btn-primary" onclick="filterTramites()">Buscar Tramite</button>
            <button class="btn btn-secondary" onclick="clearFilter()" style="margin-left: auto;text-align: right;">Limpiar</button>
        </div>

        <div id="tramitesTable" class="table-responsive">
            <div class="loading">Cargando trámites...</div>
        </div>
        <div id="tramitesPagination" class="mt-3"></div>
    </div>
    
    <!-- Step 5: Detalles de Trámite -->
    <div id="step5" class="step-container">
        <h2>Detalles del Trámite: <span id="currentTramite"></span></h2>
        <button onclick="backToStep4()" class="btn btn-secondary">← Volver a Trámites</button>
   
        <!-- Tabs corregidos para Bootstrap 5 -->
        <ul class="nav nav-tabs" id="tramiteTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="eventos-tab" data-bs-toggle="tab" data-bs-target="#eventosTab" 
                        type="button" role="tab" aria-controls="eventosTab" aria-selected="true">
                    Eventos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cambios-tab" data-bs-toggle="tab" data-bs-target="#cambiosTab" 
                        type="button" role="tab" aria-controls="cambiosTab" aria-selected="true">
                    Cambios
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="tramiteTabsContent">
            <div id="eventosTab" class="tab-pane fade show active" role="tabpanel" aria-labelledby="eventos-tab">
                <div id="eventosTable" class="table-responsive">
                    <div class="loading">Cargando eventos...</div>
                </div>
            </div>
            <div id="cambiosTab" class="tab-pane fade show" role="tabpanel" aria-labelledby="cambios-tab">
                <div id="cambiosTable" class="table-responsive">
                    <div class="loading">Cargando cambios...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="script.js"></script>
</body>
</html>